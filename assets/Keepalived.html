<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TP Keepalived – Haute Disponibilité VRRP</title>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6;margin:0;padding:24px;background:#0d1117;color:#e6edf3}
    h1,h2,h3{color:#fff;font-weight:700}
    h1{margin-top:0}
    code,pre{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:10px;display:block;color:#c9d1d9;font-size:0.95rem}
    pre{overflow:auto;line-height:1.5}
    ul{padding-left:20px}
    .note{background:#161b22;border:1px solid #30363d;border-radius:12px;padding:14px;margin:16px 0;color:#9ca3af}
    .section{background:#0f1624;border:1px solid #1f2937;border-radius:16px;padding:18px;margin-bottom:18px;box-shadow:0 16px 40px rgba(0,0,0,.35)}
  </style>
</head>
<body>
  <h1>TP Keepalived – Haute Disponibilité avec VRRP</h1>
  <p>Objectif : assurer la continuité d’accès à l’adresse virtuelle d’un service en cas de panne d’un routeur principal.</p>

  <div class="section">
    <h2>1. Rôle de Keepalived</h2>
    <ul>
      <li>Publie une <strong>adresse IP virtuelle</strong> (VIP) partagée entre plusieurs routeurs.</li>
      <li>S’appuie sur le protocole <strong>VRRP</strong> (Virtual Router Redundancy Protocol).</li>
      <li>Assure une <strong>bascule automatique</strong> si le routeur principal n’est plus joignable.</li>
    </ul>
  </div>

  <div class="section">
    <h2>2. Installation de Keepalived (Debian)</h2>
    <pre><code>sudo apt update && sudo apt upgrade -y
sudo apt install keepalived -y

# Vérifier l’installation
keepalived --version
sudo systemctl status keepalived
</code></pre>
  </div>

  <div class="section">
    <h2>3. Configuration réseau préalable</h2>
    <p>Exemple d’adressage sur deux routeurs :</p>
    <ul>
      <li><strong>routeur1</strong> : 192.168.20.10/24</li>
      <li><strong>routeur2</strong> : 192.168.20.20/24</li>
      <li><strong>VIP</strong> : 192.168.20.30/24</li>
      <li>Passerelle pour les clients : 192.168.20.30</li>
    </ul>
    <p>Activer le routage IPv4 :</p>
    <pre><code>sudo nano /etc/sysctl.conf
net.ipv4.ip_forward=1
sudo sysctl -p</code></pre>
  </div>

  <div class="section">
    <h2>4. Exemple de configuration Keepalived</h2>
    <pre><code>sudo nano /etc/keepalived/keepalived.conf

vrrp_instance VI_1 {
  state MASTER            # BACKUP sur le second nœud
  interface ens33         # adapter à l’interface réseau
  virtual_router_id 51
  priority 150            # 100 sur le nœud backup
  advert_int 1
  authentication {
    auth_type PASS
    auth_pass vrrp123
  }
  virtual_ipaddress {
    192.168.20.30/24
  }
}
</code></pre>
    <p>Redémarrer le service pour appliquer les changements :</p>
    <pre><code>sudo systemctl restart keepalived
sudo systemctl enable keepalived</code></pre>
  </div>

  <div class="section">
    <h2>5. Tests de bascule</h2>
    <ul>
      <li>Depuis un poste client, <code>ping 192.168.20.30</code> pour vérifier la VIP.</li>
      <li>Simuler une panne du maître (<code>sudo systemctl stop keepalived</code>) et vérifier la continuité du ping.</li>
      <li>Relancer le service et confirmer le retour automatique du maître (<code>ip a</code> pour visualiser la VIP).</li>
    </ul>
  </div>

  <p class="note">Astuce : ajouter un <strong>track_script</strong> pour surveiller un service critique (ex. <code>nginx</code>) et déclencher la bascule si le service est indisponible.</p>
</body>
</html>
